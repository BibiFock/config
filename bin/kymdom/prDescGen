#!/bin/bash

# FUNCTIONS_DEFINITION
COLOR_RESET="\\033[0m"
COLOR_YELLOW="\\033[33m"
COLOR_GREEN="\\033[32m"
COLOR_RED="\\033[31m"
COLOR_MAGENTA="\\033[35m"
COLOR_BOLD="\\e[1m"

function confirmation {
    echo -e $COLOR_YELLOW
    read -p "${1:-Do It?} " -n 1 -r
    echo -e $COLOR_RESET   # (optional) move to a new line
    if ! [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "\n"
        if type "fortune" &> /dev/null; then
            echo -e $COLOR_MAGENTA"$(fortune ~/config/fortune/quotes)" $COLOR_RESET
        else
            echo -e $COLOR_MAGENTA"See you next time!!"$COLOR_RESET
        fi
        echo -e "\n"
        exit
    fi
}

BRANCHE_SOURCE=${1:-"master"}
packagesDir=$(getImpactedPackages $BRANCHE_SOURCE)

packages=$(getNPMWorkspaces)

for value in $packagesDir
do
	package=$([[ ${packages[*]} =~ "@kymdom/${value}" ]] && echo "@kymdom/${value}" || echo $value)
	impacted="$impacted $package"
done;

commits=$(git log origin/$BRANCHE_SOURCE..HEAD --pretty=format:'%s')

echo "## Issues"
issues=$(echo $commits | grep -Eo "(#[0-9]+)"| sort | uniq | tr "\n" " ");
for issue in $issues
do
	echo " - fix $issue"
done

echo
echo "## Impacted packages"

for value in $impacted
do
	echo " - \`${value}\`"
done

echo
