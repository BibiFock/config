#!/bin/bash

RESET="\\033[0m"
YELLOW="\\033[33m"
GREEN="\\033[32m"
RED="\\033[31m"

LIBPATH="/www/library/php/classes/Wb/Controller/"
WORKDIR="${HOME}${LIBPATH}"
AdminFile="${WORKDIR}AdminAction.php"
SitesFile="${WORKDIR}Action.php"

# if no need to check by cmd line
#if [ ! -c FILE ]; then
    #exit
#fi

if [[ $1 == "-h" ]]; then
    echo -e "---------------------------------"
    echo -e "-si/sa  site or admin"
    echo -e "-ad/aa ads or adsadmin"
    echo -e "-p     use prod (dev by default)"
    echo -e "---------------------------------"
fi


function useDbProd() {
    replace="' . \\\$environment . '"
    if [[ $2 == "p" ]]; then
        replace="www"
    fi
    sed -i "s:/[^/]\+/databases.ini:/${replace}/databases.ini:g" $1
}

function checkStates() {
    dev="${GREEN}[dev]${RESET}"
    prod="${RED}[dev]${RESET}"
    AdminState=$dev
    SitesState=$dev
    AdsAdminState=$dev
    AdsState=$dev
    PromptState=""

    files=( $(grep -Rinl "www/databases.ini" $WORKDIR ) )

    for i in "${files[@]}"
    do
        if [[ $i == $AdminFile ]]; then
            AdminState=$prod
            PromptState=$PromptState"sa|"
        elif [[ $i == $SitesFile ]]; then
            SitesState=$prod
            PromptState=$PromptState"si|"
        fi
    done

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $AdsAdminFile | wc -l ) )
    if [[ $exist == "1" ]]; then
        AdsAdminState=$prod
        PromptState=$PromptState"aa|"
    fi

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $AdsFile | wc -l ) )
    if [[ $exist == "1" ]]; then
        AdsState=$prod
        PromptState=$PromptState"ad "
    fi

    if [ -n "$1" ]; then
        echo -e "================================="
        echo -e "${YELLOW}Admin     ${AdminState}"
        echo -e "${YELLOW}Sites     ${SitesState}"
        echo -e "---------------------------------"
        echo -e "${YELLOW}AdsAdmin  ${AdsAdminState}"
        echo -e "${YELLOW}Ads       ${AdsState}"
        echo -e "================================="
    else
        if [[ $PromptState != "" ]]; then
            echo -e " ${PromptState}"
        fi
    fi
}

affState=""
for i; do
    neededState=$(echo $i | sed -e 's/[^p]//g')
    if echo $i | grep -iq 'sa'; then
        useDbProd $AdminFile $neededState
        affState="ok"
    fi
    if echo $i | grep -iq 'si'; then
        useDbProd $SitesFile $neededState
        affState="ok"
    fi

    if echo $i | grep -iq 'aa'; then
        useAdsAdminDbProd $AdsAdminFile $neededState
        affState="ok"
    fi
    if echo $i | grep -iq 'ad'; then
        useAdsDbProd $AdsFile $neededState
        affState="ok"
    fi
done

checkStates $affState

