#!/bin/bash

RESET="\\033[0m"
YELLOW="\\033[33m"
GREEN="\\033[32m"
RED="\\033[31m"

LIBPATH="/www/library/php/classes/Wb/Controller/"
WORKDIR="${HOME}${LIBPATH}"
AdminFile="${WORKDIR}AdminAction.php"
SitesFile="${WORKDIR}Action.php"

# if no need to check by cmd line
#if [ ! -c FILE ]; then
    #exit
#fi

if [[ $1 == "-h" ]]; then
    echo -e "---------------------------------"
    echo -e "-s/a   site or admin"
    echo -e "-p     use prod (dev by default)"
    echo -e "---------------------------------"
fi


function useDbProd() {
    replace="' . \\\$environment . '"
    if [[ $2 == "p" ]]; then
        replace="www"
    fi
    sed -i "s:/[^/]\+/databases.ini:/${replace}/databases.ini:g" $1
}

function checkStates() {
    AdminState="${GREEN}[dev]${RESET}"
    SitesState="${GREEN}[dev]${RESET}"
    PromptState=""

    files=( $(grep -Rinl "www/databases.ini" $WORKDIR ) )

    for i in "${files[@]}"
    do
        if [[ $i == $AdminFile ]]; then
            AdminState="${RED}[PROD]${RESET}"
            PromptState=$PromptState"a"
        elif [[ $i == $SitesFile ]]; then
            SitesState="${RED}[PROD]${RESET}"
            PromptState=$PromptState"s"
        fi
    done

    if [ -n "$1" ]; then
        echo -e "================================="
        echo -e "${YELLOW}Sites ${SitesState}"
        echo -e "${YELLOW}Admin ${AdminState}"
        echo -e "================================="
    else
        if [[ $PromptState != "" ]]; then
            echo -e " ${PromptState}"
        fi
    fi
}

affState=""
for i; do
    neededState=$(echo $i | sed -e 's/[^p]//g')
    if [ -n "$(echo $i | sed -e 's/[^a]//g')" ]; then
        useDbProd $AdminFile $neededState
        affState="ok"
    fi
    if [ -n "$(echo $i | sed -e 's/[^s]//g')" ]; then
        useDbProd $SitesFile $neededState
        affState="ok"
    fi
done

checkStates $affState

