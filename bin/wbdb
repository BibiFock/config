#!/bin/bash

RESET="\\033[0m"
YELLOW="\\033[33m"
GREEN="\\033[32m"
RED="\\033[31m"

AdsAdminFile="/var/www/tools/adsadmin/configs/config.ini"
AdsFile="/var/www/tools/ads/_configs/config_dev.ini"

# if no need to check by cmd line
#if [ ! -c FILE ]; then
    #exit
#fi

if [[ $1 == "-h" ]]; then
    echo -e "-------------------------------------"
    echo -e "-aa/ad     adsadmin or ads"
    echo -e "-p         use prod (dev by default)"
    echo -e "-------------------------------------"
fi


function useAdsAdminDbProd() {

    if [[ $2 != "p" ]]; then
        sed -i '/;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; SCRIPT WBDB PROD/,/;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; \/ SCRIPT WBDB PROD/d' $1
        return
    fi

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $1 | wc -l ) )
    if [[ $exist == "1" ]]; then
        return
    fi
db="\n;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; SCRIPT WBDB PROD\n\
<fill prod config>\n\
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; \/ SCRIPT WBDB PROD"

    sed -i "/session.handler=mysqli/i$db" $1
}

function useAdsDbProd() {
    if [[ $2 != "p" ]]; then
        sed -i '/;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; SCRIPT WBDB PROD/,$d' $1
        return
    fi

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $1 | wc -l ) )
    if [[ $exist == "1" ]]; then
        return
    fi

    cat >> $1 <<- EndOfMessage
\n;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; SCRIPT WBDB PROD
<fill prod config>
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; /SCRIPT WBDB PROD
EndOfMessage
}

function checkStates() {
    dev="${GREEN}[dev]${RESET}"
    prod="${RED}[dev]${RESET}"
    AdminState=$dev
    SitesState=$dev
    AdsAdminState=$dev
    AdsState=$dev
    PromptState=""

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $AdsAdminFile | wc -l ) )
    if [[ $exist == "1" ]]; then
        AdsAdminState=$prod
        PromptState=$PromptState"aa|"
    fi

    exist=( $(grep -l "; SCRIPT WBDB PROD$" $AdsFile | wc -l ) )
    if [[ $exist == "1" ]]; then
        AdsState=$prod
        PromptState=$PromptState"ad "
    fi

    if [ -n "$1" ]; then
        echo -e "================================="
        echo -e "${YELLOW}AdsAdmin  ${AdsAdminState}"
        echo -e "${YELLOW}Ads       ${AdsState}"
        echo -e "================================="
    else
        if [[ $PromptState != "" ]]; then
            echo -e " ${PromptState}" | sed -e 's/.$//g'
        fi
    fi
}

affState=""
for i; do
    neededState=$(echo $i | sed -e 's/[^p]//g')

    if echo $i | grep -iq 'aa'; then
        useAdsAdminDbProd $AdsAdminFile $neededState
        affState="ok"
    fi
    if echo $i | grep -iq 'ad'; then
        useAdsDbProd $AdsFile $neededState
        affState="ok"
    fi
done

checkStates $affState

