#!/usr/bin/env bash

RED="\\033[31m"
BOLD="\\e[1m"
RESET="\\033[0m"
GREEN="\\033[32m"

function isOk {
    [ $? -ne 0 ] && echo -e "$RED$1\n\n==> FAILED$RESET" && exit
}

NINJA_PWD=$KYMDOM_NINJA_PWD

BRANCH_NAME=$1
BRANCHE_SOURCE=${2:-"master"}

echo Connecting to database with user ninja...

DOCKER_PID=$(docker run -d -v $(pwd)/infra/gcp/cloud-sql-sa.json:/config -p 127.0.0.1:5432:5432 gcr.io/cloudsql-docker/gce-proxy:1.31.2-alpine /cloud_sql_proxy -instances=kymdom:europe-west1:kymdom=tcp:0.0.0.0:5432 -credential_file=/config)

sleep 2

PG_OPTS="host=127.0.0.1 sslmode=disable dbname=master user=ninja"

if [[ ! -z "$NINJA_PWD" ]]; then
    PG_OPTS="$PG_OPTS password=$NINJA_PWD"
fi

echo creating $BRANCH_NAME database...

psql "$PG_OPTS" <<EOF
  SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '$BRANCHE_SOURCE' AND pid <> pg_backend_pid();CREATE DATABASE "$BRANCH_NAME" WITH TEMPLATE '$BRANCHE_SOURCE';
EOF

echo Stopping and removing GCE proxy Docker container

docker stop $DOCKER_PID 1>/dev/null
docker rm $DOCKER_PID 1>/dev/null

# if zombies exist => docker rm $(docker ps -a -q)
